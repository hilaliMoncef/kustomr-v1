{% extends 'main/layout.html' %}

{% block content %}
{% load static %}

<div class="row d-none" id="loggedIn">
    <div class="col-md-8 col">
        <div class="divider">
            <div class="hr"></div>
            <div class="text">Retrouvez vos réseaux sociaux ci-dessous :</div>
            <div class="hr"></div>
        </div>
        <div class="row">
            <div class="col-4">
                <div class="card card-social facebook">
                    <div class="card-header">
                        <span class="title text-uppercase">Facebook</span>
                        <hr>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div class="d-flex flex-column align-items-center text-center">
                            <span class="font-weight-bold text-dark" id="fb-fan-count">17546</span>
                            <span>J'aime</span>
                        </div>
                        <div class="d-flex flex-column align-items-center text-center">
                            <span class="font-weight-bold text-dark" id="fb-fan-engagement">7,56%</span>
                            <span>Engagement</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card card-social instagram">
                    <div class="card-header">
                        <span class="title text-uppercase">Instagram</span>
                        <hr>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div class="d-flex flex-column align-items-center text-center">
                            <span class="font-weight-bold text-dark">17546</span>
                            <span>J'aime</span>
                        </div>
                        <div class="d-flex flex-column align-items-center text-center">
                            <span class="font-weight-bold text-dark">7,56%</span>
                            <span>Engagement</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card card-social twitter">
                    <div class="card-header">
                        <span class="title text-uppercase">Twitter</span>
                        <hr>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div class="d-flex flex-column align-items-center text-center">
                            <span class="font-weight-bold text-dark">17546</span>
                            <span>J'aime</span>
                        </div>
                        <div class="d-flex flex-column align-items-center text-center">
                            <span class="font-weight-bold text-dark">7,56%</span>
                            <span>Engagement</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="title text-uppercase">Vos réseaux sociaux</div>
                    </div>
                    <div class="card-body">
                        <div id="social-chart">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 col">
        <a href="#" class="btn btn-primary w-100">Créer une publication</a>
        <div class="card my-3">
            <div class="card-body">
                <div id="social-calendar"></div>
                <hr>
                <h4 class="text-center">Aujourd'hui</h4>
                <ul class="metrics list-unstyled mt-4">
                    <li>
                        <span>Panier moyen</span>
                        <span class="text-primary font-weight-bold">36,65€</span>
                    </li>
                    <li>
                        <span>Fréquence des visites</span>
                        <span class="text-primary font-weight-bold">3 fois / mois</span>
                    </li>
                    <li>
                        <span>Taux d'engagement</span>
                        <span class="text-primary font-weight-bold">5</span>
                    </li>
                </ul>
            </div>
        </div>
        <button type="button" class="btn btn-info" id="logoutAPI">Déconnexino API</button>

    </div>

</div>

<div class="row d-none" id="logIn">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <div class="fb-login-button" data-scope="manage_pages,read_insights" data-size="medium"
                    data-button-type="continue_with" data-layout="rounded" data-auto-logout-link="false"
                    data-use-continue-as="true" data-width=""></div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/fr_FR/sdk.js#xfbml=1&version=v6.0&appId=2676493982591304&autoLogAppEvents=1"></script>
<script>
    $(document).ready(function () {
        // FACEBOOK SDK LOGIC HERE
        var userToken, userID, pageToken, pageID;

        $.ajaxSetup({ cache: true });
        $("#page-content-wrapper").loading();
        $.getScript('https://connect.facebook.net/fr_FR/sdk.js', function () {
            FB.init({
                appId: '2676493982591304',
                version: 'v5.0' // or v2.1, v2.2, v2.3, ...
            });
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        });

        function statusChangeCallback(response) {
            console.log(response);
            if (response.status == 'connected') {
                // OK : We are connected and we have a token
                $('#loggedIn').removeClass('d-none');
                $('#logIn').addClass('d-none');
                userToken = response.authResponse.accessToken;
                userID = response.authResponse.userID;

                // Now using this tokens we get the Page infos and Token
                FB.api(
                    "/" + userID + "/accounts",
                    {
                        "access_token": userToken
                    },
                    function (response) {
                        if (response && !response.error) {
                            pageToken = response.data[0].access_token;
                            pageID = response.data[0].id;
                            console.log(pageID);

                            // We call the function to retrieve page data
                            getPageInfo();
                            getPageMetrics();
                            $("#page-content-wrapper").loading('stop');
                        }
                    }
                );
            } else if (response.status == 'unknown') {
                // UNAUTHORIZED : We are not connected, show login button
                $('#logIn').removeClass('d-none');
                $('#loggedIn').addClass('d-none');
                $("#page-content-wrapper").loading('stop');
            }
        }

        function getPageInfo() {
            // This fucntion is used to get Facebook Page infos
            FB.api(
                "/"+ pageID,
                {
                    "fields": "fan_count"
                },
                function (response) {
                    if (response && !response.error) {
                        /* handle the result */
                        $('#fb-fan-count').text(response.fan_count);
                    }
                    console.warn(response)
                }
            );
        }

        function getPageMetrics() {
            // This fucntion is used to get Facebook Page infos
            FB.api(
                "/"+ pageID +"/insights",
                {
                    "metric": "page_engaged_users,page_impressions",
                    "period": "week",
                    "access_token" : pageToken
                },
                function (response) {
                    if (response && !response.error) {
                        /* handle the result */
                        var taux = response.data[0].values[0].value / response.data[1].values[0].value
                        $('#fb-fan-engagement').text(taux);
                    }
                    console.warn(response)
                }
            );
        }

        $('#logoutAPI').click(function(e) {
            e.preventDefault();
            FB.logout(response.authResponse, function(resp) {
                // user is now logged out
                $('#loggedIn').addClass('d-none');
                $('#logIn').removeClass('d-none');
            });
        });



        var calendarEl = document.getElementById('social-calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['dayGrid', 'frLocale'],
            height: 'auto',
            locale: 'fr',
            fixedWeekCount: false
        });

        calendar.render();
    });

    // CHARTS
    var socialChartoptions = {
        chart: {
            stacked: true,
            type: 'bar',
            toolbar: { show: false },
            height: 290,
        },
        plotOptions: {
            bar: {
                columnWidth: '10%'
            }
        },
        colors: ['#3b5999', '#e4405f', '#55acee'],
        series: [{
            name: 'Facebook',
            data: [175, 125, 225, 175, 160, 189, 206, 134, 159, 216, 148, 123]
        }, {
            name: 'Instagram',
            data: [175, 125, 225, 175, 160, 189, 206, 134, 159, 216, 148, 123]
        }, {
            name: 'Twitter',
            data: [175, 125, 225, 175, 160, 189, 206, 134, 159, 216, 148, 123]
        }],
        grid: {
            borderColor: '#F2F2F2',
            padding: {
                left: 0,
                right: 0
            }
        },
        legend: {
            show: true,
            position: 'top',
            horizontalAlign: 'left',
            offsetX: 0,
            fontSize: '14px',
            markers: {
                radius: 50,
                width: 10,
                height: 10,
            }
        },
        dataLabels: {
            enabled: false
        },
        xaxis: {
            labels: {
                style: {
                    colors: '#A1A1A1',
                }
            },
            axisTicks: {
                show: false,
            },
            categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            axisBorder: {
                show: false,
            },
        },
        yaxis: {
            tickAmount: 5,
            labels: {
                style: {
                    color: '#A1A1A1',
                }
            }
        },
        tooltip: {
            x: { show: false }
        },
    }
    var socialChart = new ApexCharts(
        document.querySelector("#social-chart"),
        socialChartoptions
    );

    socialChart.render();
</script>
{% endblock %}